<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>SCALE13x: Linux Profiling at Netflix</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/blog/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/blog/css/main.css">

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-7747513-3']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

    </head>
    <body>

	<div class="nav">
	<p class="navhdr">This Site:</p>
<a href="/index.html">Homepage</a><br>
<a href="/blog/index.html">Blog</a><br>
<a href="/sitemap.html">Full Site Map</a><br>
<a href="/sysperfbook.html">Sys Perf book</a><br>
<a href="/linuxperf.html">Linux Perf</a><br>
<a href="/methodology.html">Perf Methods</a><br>
<a href="/usemethod.html">USE Method</a><br>
<a href="/tsamethod.html">TSA Method</a><br>
<a href="/offcpuanalysis.html">Off-CPU Analysis</a><br>
<a href="/activebenchmarking.html">Active Bench.</a><br>
<a href="/flamegraphs.html">Flame Graphs</a><br>
<a href="/heatmaps.html">Heat Maps</a><br>
<a href="/frequencytrails.html">Frequency Trails</a><br>
<a href="/colonygraphs.html">Colony Graphs</a><br>
<a href="/perf.html">perf Examples</a><br>
<a href="/ktap.html">ktap Examples</a><br>
<a href="/dtrace.html">DTrace Tools</a><br>
<a href="/dtracetoolkit.html">DTraceToolkit</a><br>
<a href="/dtkshdemos.html">DtkshDemos</a><br>
<a href="/guessinggame.html">Guessing Game</a><br>
<a href="/specials.html">Specials</a><br>
<a href="/books.html">Books</a><br>
<a href="/sites.html">Other Sites</a><br>

	</div>

	<div class="recent">
	Recent posts:<br>
	<ul style="padding-left:18px">
	  
		   <li>06 Mar 2015 &raquo;<br>
		   <a href="/blog/2015-03-06/performance-analysis-bsd.html">  
		   MeetBSD CA: Performance Analysis of BSD</a></li>
	  
		   <li>03 Mar 2015 &raquo;<br>
		   <a href="/blog/2015-03-03/performance-tuning-linux-instances-on-ec2.html">  
		   Performance Tuning Linux Instances on EC2</a></li>
	  
		   <li>28 Feb 2015 &raquo;<br>
		   <a href="/blog/2015-02-28/from-dtrace-to-linux.html">  
		   Tracing Summit 2014: From DTrace To Linux</a></li>
	  
		   <li>27 Feb 2015 &raquo;<br>
		   <a href="/blog/2015-02-27/linux-profiling-at-netflix.html">  
		   SCALE13x: Linux Profiling at Netflix</a></li>
	  
		   <li>26 Feb 2015 &raquo;<br>
		   <a href="/blog/2015-02-26/linux-perf-off-cpu-flame-graph.html">  
		   Linux perf_events Off-CPU Time Flame Graph</a></li>
	  
		   <li>20 Jan 2015 &raquo;<br>
		   <a href="/blog/2015-01-20/working-at-netflix.html">  
		   Working at Netflix</a></li>
	  
		   <li>31 Dec 2014 &raquo;<br>
		   <a href="/blog/2014-12-31/linux-page-cache-hit-ratio.html">  
		   Linux Page Cache Hit Ratio</a></li>
	  
		   <li>22 Nov 2014 &raquo;<br>
		   <a href="/blog/2014-11-22/linux-perf-tools-2014.html">  
		   Linux Performance Tools 2014</a></li>
	  
		   <li>09 Nov 2014 &raquo;<br>
		   <a href="/blog/2014-11-09/differential-flame-graphs.html">  
		   Differential Flame Graphs</a></li>
	  
		   <li>31 Oct 2014 &raquo;<br>
		   <a href="/blog/2014-10-31/cpi-flame-graphs.html">  
		   Catching Your CPUs Napping</a></li>
	  
		   <li>27 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-27/from-clouds-to-roots.html">  
		   From Clouds to Roots: Performance Analysis at Netflix</a></li>
	  
		   <li>17 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-17/node-flame-graphs-on-linux.html">  
		   node.js Flame Graphs on Linux</a></li>
	  
		   <li>15 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-15/the-msrs-of-ec2.html">  
		   The MSRs of EC2</a></li>
	  
		   <li>11 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-11/perf-kernel-line-tracing.html">  
		   Linux perf Rides the Rocket</a></li>
	  
		   <li>06 Sep 2014 &raquo;<br>
		   <a href="/blog/2014-09-06/linux-ftrace-tcp-retransmit-tracing.html">  
		   Linux ftrace TCP Retransmit Tracing</a></li>
	  
		   <li>30 Aug 2014 &raquo;<br>
		   <a href="/blog/2014-08-30/ftrace-the-hidden-light-switch.html">  
		   ftrace: The Hidden Light Switch</a></li>
	  
		   <li>23 Aug 2014 &raquo;<br>
		   <a href="/blog/2014-08-23/linux-perf-tools-linuxcon-na-2014.html">  
		   Linux Performance Tools at LinuxCon North America 2014</a></li>
	  
		   <li>28 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-28/execsnoop-for-linux.html">  
		   execsnoop For Linux: See Short-Lived Processes</a></li>
	  
		   <li>25 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-25/opensnoop-for-linux.html">  
		   opensnoop For Linux</a></li>
	  
		   <li>23 Jul 2014 &raquo;<br>
		   <a href="/blog/2014-07-23/linux-iosnoop-latency-heat-maps.html">  
		   Linux iosnoop Latency Heat Maps</a></li>
	  
	</ul>
	<a href="/blog/index.html">Blog index</a><br>
	<a href="/blog/about.html">About</a><br>
	<a href="/blog/rss.xml">RSS</a><br>
	</div>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/blog/index.html">Brendan Gregg's Blog</a></h1>
            <a class="extra" href="/blog/index.html">home</a>
          </div>

          <h2 class="big">SCALE13x: Linux Profiling at Netflix</h2>
<p class="meta">27 Feb 2015</p>

<div class="post">
<p>At the Southern California Linux Expo (<a href="http://www.socallinuxexpo.org/scale/13x">SCALE 13x</a>) last weekend, I gave a talk on Linux Profiling at Netflix using perf_events (aka &quot;perf&quot;). I covered:</p>

<ul>
<li>How to get CPU profiling to work, including tricky targets like Java and Node.js.</li>
<li>A tour of perf_events capabilities.</li>
</ul>

<p>Quick and complete CPU profiling is something everyone should be able to do. It turns out to be tricky, however, due to various gotchas I covered in the talk, including fixing stacks and symbols. </p>

<p>I also included a new map to show the events perf can instrument:</p>

<p><center><img src="/perf_events/perf_events_map.png" width=500></center></p>

<p>The room for my talk was full, and some people couldn&#39;t get in. Fortunately it was recorded, by two cameras: the room <a href="https://www.youtube.com/watch?v=5iQmm8J6sxU">livestream</a> and one in the <a href="https://www.youtube.com/watch?v=_Ik8oiQvWgo">front row</a>:</p>

<p><center><iframe width="560" height="315" src="https://www.youtube.com/embed/_Ik8oiQvWgo" frameborder="0" allowfullscreen></iframe></center></p>

<p>The slides for the talk are also on <a href="http://www.slideshare.net/brendangregg/scale2015-linux-perfprofiling">slideshare</a>:</p>

<p><center><iframe src="http://www.slideshare.net/slideshow/embed_code/44966387" width="425" height="355" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe></center></p>

<p>There is material in this talk that I&#39;ve shared for the first time: covering how to really get CPU profiling to work for Java. This is of particular importance at Netflix, since most of our application environment is Java.</p>

<p>Linux perf_events is an excellent profiler, since it works asynchronously (no JVM safety point sampling issues), and it can inspect the full stack: JVM internals, system libraries, Java code, and the kernel. No matter where a CPU issue is, perf_events can find it.</p>

<p>My highlight of the talk was a mixed-mode CPU flame graph of Java (slide 8), which I&#39;ve included below as an embedded <a href="http://www.brendangregg.com/FlameGraphs/cpu-mixedmode-vertx.svg">SVG</a>:</p>

<p><object data="/FlameGraphs/cpu-mixedmode-vertx.svg" type="image/svg+xml" width=720 height=730>
<img src="/FlameGraphs/cpu-mixedmode-vertx.svg" width=720 />
</object></p>

<p>Click to zoom. Showing all CPU usage with Java context is amazing and useful. As I mentioned in the talk, we recently found an issue using these flame graphs where CPU time was mostly spent in the JVM compiler. This issue was invisible to other Java profilers, which only focus on the execution of Java code.</p>

<p>As I covered in the talk, getting these full Java stack profiles to work is tricky, and currently involves patching OpenJDK to fix the frame pointer. My patch has been filed as <a href="https://bugs.openjdk.java.net/browse/JDK-8068945">JDK-8068945</a>, although I hope this becomes an option in both OpenJDK and OracleJDK (eg, -XX:MoreFramePointer). I also started a <a href="http://mail.openjdk.java.net/pipermail/hotspot-compiler-dev/2014-December/016477.html">thread</a> about this on the hotspot compiler dev mailing list.</p>

<p>If you&#39;re not interested in Java profiling, I&#39;d still recommend watching this talk. Java makes for an interesting use case for getting system profiling to work, and the same issues may be encountered in other runtimes.</p>

<p>In the talk I included a crash course for perf_events, and many one-liners to tour its capabilities. These included one-liners for counting events, profiling, static tracing, and dynamic tracing. Some examples:</p>

<pre>
# Sample CPU stack traces for the specified PID, at 99 Hertz, for 10 seconds:
<b>perf record -F 99 -p PID -g -- sleep 10</b>

# Sample CPU stack traces for the entire system, at 99 Hertz, for 10 seconds:
<b>perf record -F 99 -ag -- sleep 10</b>

# Sample CPU stack traces, once every 10,000 Level 1 data cache misses, for 5 s:
<b>perf record -e L1-dcache-load-misses -c 10000 -ag -- sleep 5</b>

# Sample CPU stack traces, once every 100 last level cache misses, for 5 seconds:
<b>perf record -e LLC-load-misses -c 100 -ag -- sleep 5 </b>

# Sample on-CPU kernel instructions, for 5 seconds:
<b>perf record -e cycles:k -a -- sleep 5 </b>
...
</pre>

<p>For more about perf, see my <a href="http://www.brendangregg.com/perf.html">perf_events page</a> which has full lists of these one-liners, the <a href="https://perf.wiki.kernel.org/index.php/Main_Page">perf wiki</a>, and the documentation in the Linux source under tools/perf/Documentation.</p>

<p>SCALE, as always, is a really good conference, and I had a great time meeting people and listing to what others are working on. My thanks to the volunteers who run SCALE, as well as <a href="http://www.beginningwithi.com/">Deirdr√© Straughan</a> for editing the video, and <a href="https://twitter.com/hkarmark">Harsh Karmarkar</a> from Apcera for running the camera.</p>

</div>



<br><hr>
<div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'brendangregg';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


          <div class="footer">
            <div class="contact">
                Copyright 2015 Brendan Gregg.<br><a href="/blog/about.html">About this blog</a>
            </div>
          </div>
        </div>

    </body>
</html>
